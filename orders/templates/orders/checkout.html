{% extends "base.html" %}
{% load static %}

{% block title %}Checkout – Play & Jump{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-16 relative overflow-hidden">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center relative z-10">
    <h1 class="text-4xl md:text-6xl font-bold mb-4 animate-fade-in-up">Checkout</h1>
    <p class="text-xl md:text-2xl mb-8 animate-fade-in-up-delay">Vervollständigen Sie Ihre Bestellung</p>
  </div>
</div>

<!-- Checkout Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <div class="grid lg:grid-cols-2 gap-12">
    
    <!-- Order Summary -->
    <div class="lg:order-2">
      <div class="bg-white rounded-xl shadow-lg p-6 sticky top-4">
        <h2 class="text-2xl font-bold mb-6 text-gray-900">Bestellübersicht</h2>
        
        <!-- Cart Items -->
        <div class="space-y-4 mb-6">
          {% for item in cart.items.all %}
            <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
              <div class="flex-shrink-0">
                {% if item.product and item.product.image %}
                  <img src="{{ item.product.image.url }}" alt="{{ item.product.title }}" 
                       class="w-16 h-16 object-cover rounded-lg">
                {% elif item.service and item.service.image %}
                  <img src="{{ item.service.image.url }}" alt="{{ item.service.title }}" 
                       class="w-16 h-16 object-cover rounded-lg">
                {% else %}
                  <div class="w-16 h-16 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-sm">
                      {% if item.product %}{{ item.product.title|slice:":2" }}{% else %}{{ item.service.title|slice:":2" }}{% endif %}
                    </span>
                  </div>
                {% endif %}
              </div>
              
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900">{{ item.item_name }}</h3>
                {% if item.start_date and item.end_date %}
                  <p class="text-sm text-gray-600">
                    {{ item.start_date|date:"d.m.Y" }} - {{ item.end_date|date:"d.m.Y" }}
                  </p>
                {% endif %}
                <p class="text-sm text-gray-600">Menge: {{ item.quantity }}</p>
              </div>
              
              <div class="text-right">
                <p class="font-semibold text-gray-900">€{{ item.total_price|floatformat:2 }}</p>
              </div>
            </div>
          {% endfor %}
        </div>
        
        <!-- Price Summary -->
        <div class="border-t pt-6 space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-600">Zwischensumme:</span>
            <span class="font-semibold">€{{ cart.total_price|floatformat:2 }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">MwSt. (19%):</span>
            <span class="font-semibold">€{{ cart.total_price|multiply:0.19|floatformat:2 }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Versand:</span>
            <span class="font-semibold">€<span id="shipping-amount">0.00</span></span>
          </div>
          <hr class="border-gray-200">
          <div class="flex justify-between text-lg font-bold">
            <span>Gesamt:</span>
            <span class="text-blue-600">€<span id="grand-total">{{ cart.total_price|multiply:1.19|floatformat:2 }}</span></span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Checkout Form -->
    <div class="lg:order-1">
      <div class="bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-6 text-gray-900">Kundendaten</h2>
        
        <form id="checkout-form" class="space-y-6">
          <!-- Personal Information -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-2">
                Vor- und Nachname *
              </label>
              <input type="text" id="customer_name" name="customer_name" required
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div>
              <label for="customer_email" class="block text-sm font-medium text-gray-700 mb-2">
                E-Mail-Adresse *
              </label>
              <input type="email" id="customer_email" name="customer_email" required
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
          </div>
          
          <div>
            <label for="customer_phone" class="block text-sm font-medium text-gray-700 mb-2">
              Telefonnummer
            </label>
            <input type="tel" id="customer_phone" name="customer_phone"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          
          <div>
            <label for="customer_address" class="block text-sm font-medium text-gray-700 mb-2">
              Lieferadresse *
            </label>
            <textarea id="customer_address" name="customer_address" rows="4" required
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Straße, Hausnummer, PLZ, Ort"></textarea>
          </div>
          
          <!-- Shipping Options -->
          <div>
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Versandoptionen</h3>
            <div class="space-y-3">
              <label class="flex items-center space-x-3 cursor-pointer">
                <input type="radio" name="shipping" value="0" checked
                       class="text-blue-600 focus:ring-blue-500">
                <span class="text-gray-700">Standardversand (€0.00)</span>
              </label>
              <label class="flex items-center space-x-3 cursor-pointer">
                <input type="radio" name="shipping" value="15"
                       class="text-blue-600 focus:ring-blue-500">
                <span class="text-gray-700">Expressversand (€15.00)</span>
              </label>
            </div>
          </div>
          
          <!-- Notes -->
          <div>
            <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
              Anmerkungen
            </label>
            <textarea id="notes" name="notes" rows="3"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Besondere Wünsche oder Anmerkungen..."></textarea>
          </div>
          
          <!-- Terms and Conditions -->
          <div class="flex items-start space-x-3">
            <input type="checkbox" id="terms" required
                   class="mt-1 text-blue-600 focus:ring-blue-500">
            <label for="terms" class="text-sm text-gray-700">
              Ich akzeptiere die <a href="/agb/" class="text-blue-600 hover:underline">AGB</a> und 
              <a href="/datenschutz/" class="text-blue-600 hover:underline">Datenschutzerklärung</a> *
            </label>
          </div>
          
          <!-- Submit Button -->
          <button type="submit" 
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors duration-200">
            Bestellung abschließen
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('checkout-form');
    const shippingInputs = document.querySelectorAll('input[name="shipping"]');
    const shippingAmount = document.getElementById('shipping-amount');
    const grandTotal = document.getElementById('grand-total');
    
    // Update shipping amount and total
    function updateTotals() {
        const selectedShipping = document.querySelector('input[name="shipping"]:checked');
        const shippingValue = parseFloat(selectedShipping.value);
        const subtotal = {{ cart.total_price }};
        const tax = subtotal * 0.19;
        const total = subtotal + tax + shippingValue;
        
        shippingAmount.textContent = shippingValue.toFixed(2);
        grandTotal.textContent = total.toFixed(2);
    }
    
    // Update totals when shipping option changes
    shippingInputs.forEach(input => {
        input.addEventListener('change', updateTotals);
    });
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {
            customer_name: formData.get('customer_name'),
            customer_email: formData.get('customer_email'),
            customer_phone: formData.get('customer_phone'),
            customer_address: formData.get('customer_address'),
            shipping_amount: parseFloat(document.querySelector('input[name="shipping"]:checked').value),
            notes: formData.get('notes')
        };
        
        fetch('/orders/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Bestellung erfolgreich erstellt! Bestellnummer: ' + data.order_number);
                window.location.href = data.redirect_url;
            } else {
                alert('Fehler beim Erstellen der Bestellung: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Erstellen der Bestellung.');
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 